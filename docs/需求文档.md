
## Splendor 客户端优化需求文档

**版本:** 1.0
**日期:** 2024-07-28

### 1. 引言

本文档旨在详细说明 Splendor 网页客户端需要进行的优化和功能调整。这些需求涵盖了界面响应式设计、视觉样式调整、用户交互流程改进、功能增强以及错误修复等方面，目标是提升整体用户体验和应用的健壮性。

### 2. 需求列表

---

**REQ-001: 适配小屏设备**

*   **需求描述:** 游戏界面需要在各种屏幕尺寸，特别是手机、平板等小屏幕设备上能够良好地展示和操作。
*   **目标:** 提升游戏在移动设备上的可用性和视觉效果，确保玩家在任何设备上都能获得一致的体验。
*   **分析与实现要点:**
    *   使用 Tailwind CSS 的响应式断点 (`sm:`, `md:`, `lg:` 等) 调整布局、字体大小、元素间距和尺寸。
    *   重点检查 `GameBoard`, `PlayerPanel`, `CardDisplay`, `Card`, `GemToken`, `NobleDisplay`, `Noble`, `ActionHistory`, `ChatPanel` 等组件的响应式表现。
    *   可能需要调整网格布局 (`grid-cols-*`)、弹性布局 (`flex-*`) 以及元素的显示/隐藏 (`hidden`, `block`)。
    *   确保触摸操作的友好性，按钮和可交互元素有足够的大小和间距。
*   **验收标准:**
    *   在常见的小屏幕尺寸（如 360px, 768px 宽度）下，所有界面元素清晰可见，没有重叠或超出屏幕范围。
    *   不需要过度的水平或垂直滚动即可访问核心游戏区域。
    *   文本易于阅读，按钮和宝石等可交互元素易于点击/触摸。

---

**REQ-002: 避免白色背景上的白色文字**

*   **需求描述:** 确保应用中所有文本内容与其背景色之间有足够的视觉对比度，特别是在使用白色或浅色背景的区域。
*   **目标:** 提高文本的可读性，满足无障碍设计的基本要求。
*   **分析与实现要点:**
    *   检查所有组件，特别是 `Card`, `PlayerPanel`, `ActionHistory` 以及全局样式 `globals.css`。
    *   留意使用了半透明白色背景（如 `bg-white/50`, `bg-white/80`）的元素，确保其上的文字颜色是深色或有足够的对比度。
    *   验证 `globals.css` 中定义的 `--foreground` 颜色 (`#171717`) 是否在所有默认情况下生效。
*   **验收标准:**
    *   所有界面文本与其直接背景色的对比度符合 WCAG AA 级别标准（至少 4.5:1，大号文本至少 3:1）。
    *   在任何界面状态下（如悬停、选中、禁用），文本都保持可读。

---

**REQ-003: 宝石区域和玩家信息区域置于同侧**

*   **需求描述:** 调整游戏主界面的布局，将公共宝石区域 (`GemToken`) 和所有玩家的信息面板 (`PlayerPanel`) 放置在界面的同一侧（例如右侧），将卡牌展示区 (`CardDisplay`) 和贵族区 (`NobleDisplay`) 放在另一侧（例如左侧）。
*   **目标:** 优化信息组织结构，将关联性强的区域（玩家状态和可用资源）聚合，减少用户视线移动和交互切换成本。
*   **分析与实现要点:**
    *   修改 `GameBoard.tsx` 的顶层布局结构（可能是 CSS Grid 或 Flexbox）。
    *   重新组织子组件的排列顺序和容器。
    *   需要考虑此布局调整对响应式设计 (REQ-001) 的影响，确保在小屏幕上也能合理展示。
*   **验收标准:**
    *   游戏主界面明确分为两个主要区域：卡牌/贵族区 和 玩家/宝石区。
    *   新的布局在各种屏幕尺寸下均保持结构清晰和功能正常。

---

**REQ-004: 贵族宝石样式调整与排列**

*   **需求描述:** 修改贵族卡片 (`Noble`) 上展示所需宝石条件的样式：1) 将宝石图标改为矩形；2) 让这些宝石图标尽量排列在同一行。
*   **目标:** 统一或调整视觉风格，优化贵族卡片的信息密度和空间利用率。
*   **分析与实现要点:**
    *   修改 `Noble.tsx` 组件中渲染宝石需求的部分。
    *   将宝石图标的 CSS 类从 `rounded-full` 改为 `rounded-sm` 或直接方形。
    *   调整包含这些图标的容器的 Flexbox 属性，使用 `flex-row` 和 `flex-wrap` (或 `flex-nowrap` 根据空间决定)，使其优先水平排列。
*   **验收标准:**
    *   贵族卡片上表示所需宝石数量的图标呈现为矩形或方形。
    *   宝石需求图标在空间允许的情况下水平排列在一行；若空间不足，则自动换行。

---

**REQ-006: 非当前回合界面不应变灰**

*   **需求描述:** 当不处于当前玩家的回合时，整个游戏界面不应出现整体变灰或被遮罩的效果。允许单个不可操作的元素（如卡牌）变暗或显示禁用状态，但整体背景和布局应保持清晰。
*   **目标:** 保证玩家在任何时候都能清晰地观察游戏盘面状态，避免不必要的视觉干扰。
*   **分析与实现要点:**
    *   检查 `GameBoard.tsx` 或其他高层组件，确保没有基于 `isActive` 状态施加全局的 `opacity` 或覆盖层。
    *   检查 `Card.tsx` 和 `GemToken.tsx` 等组件的 `disabled` 状态样式。当前卡牌禁用的 `opacity-60 saturate-50` 效果可能是用户反馈的“变灰”。需要确认是否保留此效果，或调整为仅影响可交互性（如移除 `cursor-pointer`）而不大幅改变外观。
    *   `PlayerPanel` 的背景色区分当前玩家（浅黄）和非当前玩家（白色）是合理的，不属于“变灰”。
*   **验收标准:**
    *   无论是否轮到当前玩家操作，游戏背景、主要布局、其他玩家信息等都保持正常的亮度和可见度。
    *   只有明确不可交互的元素（如对方回合时不能购买的卡牌、不能选取的宝石）可以显示禁用状态（如透明度降低、移除交互效果），但不能影响整体界面的观察。

---

**REQ-007: 操作历史中的宝石样式统一**

*   **需求描述:** 操作历史记录 (`ActionHistory`) 中显示的宝石信息（例如“获取宝石”、“丢弃宝石”）需要使用与宝石区域（`GemToken` 或 `PlayerPanel`）一致的视觉样式。
*   **目标:** 提升界面视觉一致性，使用户更容易关联操作记录中的宝石与其在游戏其他区域的表示。
*   **分析与实现要点:**
    *   修改 `ActionHistory.tsx` 中的 `formatAction` 函数。
    *   在渲染 `TAKE_GEMS` 和 `DISCARD_GEMS` 类型的动作时，使用带有背景色和边框的小圆圈或方块来代表宝石，并在其中显示数量，替换掉之前的 Emoji 图标。
    *   复用或参考 `PlayerPanel.tsx` 中的 `gemColorMap` 和 `gemTextColorMap` 来定义样式。
    *   确保尺寸和样式与操作历史的整体风格协调。
*   **验收标准:**
    *   操作历史记录中涉及宝石数量的条目，使用与玩家信息面板或宝石选择区相似的图形化宝石图标（带颜色背景和数量）来展示，而非纯文本或 Emoji。

---

**REQ-008: 添加选择宝石音效**

*   **需求描述:** 当玩家在宝石区域 (`GemToken`) 点击选择或右键取消选择宝石时，播放相应的音效。
*   **目标:** 增强操作反馈，提升游戏交互的沉浸感和趣味性。
*   **分析与实现要点:**
    *   准备合适的音效文件（如 `.mp3` 或 `.wav` 格式的点击音效），放置在 `public/sounds/` 目录下。
    *   创建一个用于播放音频的 React Hook 或工具函数 (e.g., `useSound` or `playSound`)。
    *   在 `GemToken.tsx` 组件的 `handleGemClick` 和 `handleGemRightClick` 函数中，在成功添加或移除 `selectedGems` 状态后，调用音效播放函数。
*   **验收标准:**
    *   左键点击可选宝石时，播放一个确认音效。
    *   右键点击已选宝石以取消选择时，播放一个取消或不同的音效。
    *   音效播放不应阻塞 UI 或引入延迟。

---

**REQ-009: 优化玩家面板展示（隐藏他人私有信息，优化本方）**

*   **需求描述:** 调整玩家信息面板 (`PlayerPanel`) 的显示逻辑：1) 默认只显示当前登录玩家自己的预留卡牌和获得的贵族；其他玩家的面板不显示这两个区域。2) 优化当前玩家面板中这两个区域的布局，使其能完整展示内容（最多3张预留卡，若干贵族）而不需要出现滚动条。
*   **目标:** 简化界面，减少信息干扰，聚焦于与当前玩家直接相关的信息。优化当前玩家私有区域的展示效果。
*   **分析与实现要点:**
    *   在 `PlayerPanel.tsx` 中，需要获取当前登录用户的 `playerId` （可能来自 `useGameStore` 或 `useAuthStore` 等）。
    *   使用条件渲染，仅当 `player.id` 等于当前用户 `playerId` 时，才渲染“预留卡”和“贵族”区域的 JSX。
    *   调整当前玩家面板内部这两个区域的 CSS 样式（可能需要更大的 `min-height`，调整 `flex` 或 `grid` 布局，减小卡牌或贵族的缩放比例 `scale`），确保内容能在常规屏幕下完整显示。
    *   需要平衡此优化与响应式设计 (REQ-001) 和整体布局 (REQ-003) 的关系，避免在小屏幕上内容溢出或布局混乱。
*   **验收标准:**
    *   非当前玩家的信息面板中不显示预留卡和贵族区域。
    *   当前玩家的信息面板中，预留卡（最多3张）和获得的贵族能够清晰、完整地展示，在桌面或平板等标准屏幕宽度下不出现水平滚动条。

---

**REQ-010: 优化游戏结束退出逻辑**

*   **需求描述:** 优化游戏结束时弹出的对话框 (`GameOverDialog`) 的交互逻辑，确保退出游戏的操作流程顺畅、清晰。
*   **目标:** 提供明确的游戏结束反馈和后续操作选项，保证用户可以顺利离开当前游戏界面。
*   **分析与实现要点:**
    *   检查 `GameOverDialog.tsx` 组件的功能和按钮事件处理。
    *   确保“返回大厅”、“关闭”或类似按钮能够正确触发页面跳转（使用 Next.js 的 `useRouter`）或状态清理。
    *   检查关闭对话框时，是否正确重置了相关的游戏状态（在 `useGameStore` 中）。
    *   如果涉及 WebSocket 连接，确保退出逻辑不会导致连接异常或状态不同步。
*   **验收标准:**
    *   游戏结束对话框提供清晰的选项（如返回主页/大厅）。
    *   点击退出选项后，用户能顺利导航到预期页面。
    *   相关的游戏状态得到清理，不会影响下一次进入游戏或应用的其他部分。

---

### 3. 修订历史

| 版本 | 日期       | 修订者 | 说明       |
| ---- | ---------- | ------ | ---------- |
| 1.0  | 2025-04-12 | Gemini | 初始版本   |

---


好的，我们先来分析和更新需求文档，然后再进行代码修改。

---

## Splendor 客户端优化需求文档 - 更新

**版本:** 1.1
**日期:** 2024-07-28

*(保留引言和之前的 REQ-001 到 REQ-010)*

---

**REQ-011: 修复游戏结束后返回大厅的状态重置逻辑**

*   **需求描述:** 当前在游戏结束对话框中点击“返回大厅”按钮时，由于 `useGameStore` 中缺少 `resetGameState` 方法或使用了错误的方法，导致程序报错且游戏状态可能未正确清理。
*   **目标:** 确保返回大厅时，客户端的游戏状态被完全重置，避免影响后续操作或新游戏，并修复相关报错。
*   **分析与实现要点:**
    *   检查 `splendor-client/app/store/gameStore.ts` 中 Zustand store 的定义。
    *   确认是否存在用于重置状态的 action。如果不存在，需要添加一个 `resetGameState` action，该 action 应将 `gameState`, `error`, `loading`, `selectedGems`, `confirmDialog` 等与单局游戏相关的状态恢复到初始值（通常是 `null` 或空对象/数组）。
    *   修改 `splendor-client/app/components/game/GameOverDialog.tsx` 中的 `handleReturnToLobby` 函数，确保调用了正确定义的 `resetGameState` action 或等效的状态重置逻辑。
*   **验收标准:**
    *   点击游戏结束对话框中的“返回大厅”按钮后，应用不再报错。
    *   导航到大厅页面 (`/`) 后，相关的游戏状态（如 `gameState`）在 store 中已被重置为 `null` 或初始状态。
    *   从大厅重新进入游戏房间时，不会残留上一局的游戏数据。

---

**REQ-012: 扩展音效覆盖范围**

*   **需求描述:** 当前仅为选择/取消选择宝石添加了音效。需要为游戏中的其他关键操作和事件添加音效反馈。
*   **目标:** 进一步增强游戏的沉浸感和交互反馈，提升用户体验。
*   **分析与实现要点:**
    *   **需要添加音效的环节:**
        *   购买发展卡 (`CardDisplay.tsx` 或 `PlayerPanel.tsx` 内的购买按钮触发)
        *   预留发展卡 (包括从展示区和牌堆预留) (`CardDisplay.tsx`, `DeckCard` 触发)
        *   成功获得贵族 (`GameBoard.tsx` 或处理 `CLAIM_NOBLE` action 的地方)
        *   轮到当前玩家的回合 (`GameBoard.tsx` 或监听 `gameState.currentTurn` 变化的地方)
        *   游戏开始 (`GameSetup.tsx` 或 `GameBoard.tsx` 初始化时)
        *   游戏结束 (显示 `GameOverDialog.tsx` 时)
        *   收到聊天消息 (`ChatPanel.tsx`) - 可选
        *   发生错误或无效操作 - 可选
    *   **实现:**
        *   准备相应的音效文件 (e.g., `purchase.mp3`, `reserve.mp3`, `noble_claim.mp3`, `turn_notify.mp3`, `game_start.mp3`, `game_over.mp3`, `message.mp3`) 并放置于 `public/sounds/` 目录下。
        *   在各相关组件的事件处理函数或 `useEffect` hook 中，调用 `playSound` 工具函数播放对应的音效。
        *   对于回合通知，需要监听 `gameState.currentTurn` 变化，并在变为当前用户 `playerId` 时播放提示音。
*   **验收标准:**
    *   在执行购买卡牌、预留卡牌、获得贵族等操作时，能听到对应的音效。
    *   游戏开始、游戏结束、轮到自己回合时，有相应的提示音效。
    *   音效播放及时、清晰，不影响游戏性能。

---

**REQ-013: 调整当前玩家预留卡和贵族卡的布局**

*   **需求描述:** 当前玩家信息面板 (`PlayerPanel`) 中的预留卡和贵族卡区域需要调整布局，改为横向排列，并且内容分布在两行内。
*   **目标:** 在有限的空间内更清晰地展示多张预留卡和贵族卡，优化当前玩家面板的视觉效果。
*   **分析与实现要点:**
    *   修改 `PlayerPanel.tsx` 中 `isSelf` 为 true 时渲染的预留卡和贵族卡区域的 JSX 结构和 CSS 类。
    *   使用 CSS Grid (`grid grid-rows-2 grid-flow-col`) 或嵌套 Flexbox (`flex flex-col` 内含两个 `flex flex-row`) 来创建两行的横向布局。
    *   调整卡片 (`Card`) 和贵族 (`Noble`) 组件的缩放比例 (`scale`)、外边距 (`margin`) 和容器的 `min-height`，以适应新的两行布局，并尽量避免出现滚动条（可能需要对显示数量较多的贵族做些妥协）。
    *   确保布局在不同屏幕尺寸下（特别是中等屏幕）也能合理展示。
*   **验收标准:**
    *   当前玩家的预留卡（最多3张）在玩家面板中横向排列，分布在两行内。
    *   当前玩家获得的贵族卡在玩家面板中横向排列，分布在两行内。
    *   布局紧凑美观，在标准屏幕宽度下通常不需要滚动条即可查看所有内容。

---

**REQ-014: 显示其他玩家的预留卡和贵族卡数量**

*   **需求描述:** 对于非当前玩家的信息面板 (`PlayerPanel`)，需要隐藏具体的预留卡和贵族卡内容，但应显示其持有的数量。
*   **目标:** 在简化对手信息的同时，保留关键的游戏计数信息，帮助玩家进行决策。
*   **分析与实现要点:**
    *   修改 `PlayerPanel.tsx`。在 `isSelf` 为 false 的条件下：
        *   移除渲染预留卡和贵族卡列表的 JSX 代码块。
        *   添加新的 JSX 元素，用于显示 `player.reservedCards.length` 和 `player.nobles.length`。
        *   可以考虑使用小的图标（如预留卡图标、贵族图标）配合数字来展示，放置在玩家信息的合适位置（如分数旁边或宝石资源下方）。
        *   样式应简洁明了，不占用过多空间。
*   **验收标准:**
    *   在其他玩家的信息面板中，不再显示具体的预留卡和贵族卡片。
    *   在其他玩家的信息面板中，能清晰地看到其当前持有的预留卡数量和贵族数量。

---

### 3. 修订历史

| 版本 | 日期       | 修订者 | 说明                 |
| ---- | ---------- | ------ | -------------------- |
| 1.1  | 2024-07-28 | Gemini | 添加 REQ-011 至 REQ-014 |
| 1.0  | 2024-07-28 | Gemini | 初始版本             |

---

现在我已经更新了需求文档。接下来，我将开始根据这些新需求修改代码。首先处理 REQ-011 (修复 `resetGameState` 错误)。
